using Microsoft.Extensions.DependencyInjection;

using Vulns.Core;
using Vulns.Jobs.Base;

namespace Vulns.Jobs.Vulnerabilities;
public class VulnerabilityFixExistenceEnricher : IEnricher<Vulnerability>
{
    public int ExecutionOrder => 5;

    public string Name => nameof(VulnerabilityFixExistenceEnricher);

    public IEnumerable<Vulnerability> Enrich(IEnumerable<Vulnerability> entities, IServiceScope scope)
    {
        foreach (var vuln in entities)
            if (vuln.References == null) continue;
            else foreach (var reference in vuln.References)
                {
                    // Fill `HasFix`
                    if (reference.Tags.Contains(VulnerabilityReferenceTag.Patch) || reference.Tags.Contains(VulnerabilityReferenceTag.Mitigation))
                        vuln.HasFix = true;
                }
        return entities;
    }
}