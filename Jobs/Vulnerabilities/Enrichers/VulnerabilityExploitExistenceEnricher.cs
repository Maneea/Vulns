using Microsoft.Extensions.DependencyInjection;

using Vulns.Core;
using Vulns.Jobs.Base;

namespace Vulns.Jobs.Vulnerabilities;
public class VulnerabilityExploitExistenceEnricher : IEnricher<Vulnerability>
{
    public int ExecutionOrder => 4;

    public string Name => nameof(VulnerabilityExploitExistenceEnricher);

    public IEnumerable<Vulnerability> Enrich(IEnumerable<Vulnerability> entities, IServiceScope scope)
    {
        foreach (var vuln in entities)
            if (vuln.References == null) continue;
            else foreach (var reference in vuln.References)
                {
                    // Fill `HasExploit`
                    if (reference.Url.Contains("exploit-db.com/exploits/"))
                    {
                        vuln.HasExploit = true;
                        if (!reference.Tags.Contains(VulnerabilityReferenceTag.Exploit))
                            reference.Tags.Add(VulnerabilityReferenceTag.Exploit);
                    }
                    else if (reference.Tags.Contains(VulnerabilityReferenceTag.Exploit))
                        vuln.HasExploit = true;
                }
        return entities;
    }
}