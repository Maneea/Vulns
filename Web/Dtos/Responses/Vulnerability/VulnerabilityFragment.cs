using Vulns.Core;

namespace Vulns.Web;
public class VulnerabilityFragment
{
    public DateTime PublishedAt { get; set; }
    public DateTime ModifiedAt { get; set; }
    public string Id { get; set; } = DtoConstants.Unspecified;
    public string Description { get; set; } = DtoConstants.Unspecified;
    public string Issuer { get; set; } = DtoConstants.Unknown;
    public string IssuerId { get; set; } = DtoConstants.Unknown;
    public string VectorString { get; set; } = DtoConstants.Unknown;
    public string Level { get; set; } = DtoConstants.Unspecified;
    public string ConfidentialityImpact { get; set; } = DtoConstants.Unspecified;
    public string IntegrityImpact { get; set; } = DtoConstants.Unspecified;
    public string AvailabilityImpact { get; set; } = DtoConstants.Unspecified;
    public string AttackVector { get; set; } = DtoConstants.Unspecified;
    public string AttackComplexity { get; set; } = DtoConstants.Unspecified;
    public string RequiredAuthentication { get; set; } = DtoConstants.Unspecified;
    public double BaseScore { get; set; }
    public double ImpactScore { get; set; }
    public double ExploitabilityScore { get; set; }
    public bool ObtainAllPrivilege { get; set; }
    public bool ObtainUserPrivilege { get; set; }
    public bool ObtainOtherPrivilege { get; set; }
    public bool UserInteractionRequired { get; set; }
    public bool HasExploit { get; set; }
    public bool HasFix { get; set; }
    public List<ProductFragment>? VulnerableProducts { get; set; }
    public ICollection<WeaknessFragment>? Weaknesses { get; set; }

    public VulnerabilityFragment RemoveDuplicateProducts()
    {
        VulnerableProducts = VulnerableProducts?.DistinctBy(p => new { p.Vendor, p.Product, p.Title }).ToList();
        return this;
    }

    public VulnerabilityFragment GenerateProductTitles()
    {
        VulnerableProducts?.ForEach(p =>
        {
            var lowerTitle = p.Title?.ToLower() ?? string.Empty;
            p.Product = lowerTitle.IndexOf(p.Product) >= 0 && p.Title != null ? p.Title.Substring(lowerTitle.IndexOf(p.Product), p.Product.Length) : p.Product.Humanize();
            p.Vendor = lowerTitle.IndexOf(p.Vendor) >= 0 && p.Title != null ? p.Title.Substring(lowerTitle.IndexOf(p.Vendor), p.Vendor.Length) : p.Vendor.Humanize();
            p.Title = string.IsNullOrEmpty(p.Title) ?
                $"{(p.Product.Contains(p.Vendor) ? "" : p.Vendor)} {p.Product}" :
                p.Title;
        });
        return this;
    }
}